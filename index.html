<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>Eato-style дневной бюджет • Прототип v2</title>
<meta name="theme-color" content="#111111">
<link rel="manifest" id="app-manifest">
<style>
  :root{
    --bg:#0d0d0f; --card:#151518; --text:#f2f2f7; --muted:#a1a1aa; --acc:#4ade80; --warn:#f59e0b; --danger:#ef4444; --ring:#2dd4bf;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;-webkit-font-smoothing:antialiased; line-height:1.4;}
  header{position:sticky;top:0;background:linear-gradient(180deg,#0d0d0fee,#0d0d0f 85%);padding:12px 16px 8px;border-bottom:1px solid #222}
  h1{font-size:18px;margin:0}
  .container{max-width:880px;margin:0 auto;padding:12px 12px 100px}
  .card{background:var(--card);border:1px solid #222;border-radius:14px;padding:12px;margin:10px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .col{flex:1}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  input,select,textarea{width:100%;padding:12px;border-radius:12px;background:#0e0e11;border:1px solid #2a2a30;color:var(--text);outline:none}
  textarea{min-height:110px;resize:vertical}
  button{appearance:none;border:0;border-radius:12px;padding:12px 14px;background:var(--acc);color:#052e16;font-weight:700;cursor:pointer}
  button.secondary{background:#26262b;color:var(--text);border:1px solid #2f2f36}
  button.warn{background:var(--warn);color:#3b2600}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a2a30;border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .kpi{display:flex;justify-content:space-between;align-items:baseline}
  .big{font-size:32px;font-weight:800}
  .muted{color:var(--muted)}
  progress{width:100%;height:12px;-webkit-appearance:none;appearance:none}
  progress::-webkit-progress-bar{background:#1b1b20;border-radius:999px}
  progress::-webkit-progress-value{background:var(--ring);border-radius:999px}
  small{color:var(--muted)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .tab{padding:8px 10px;border:1px solid #2a2a30;border-radius:10px;cursor:pointer}
  .tab.active{background:#1b1b20}
  .footer{position:fixed;left:0;right:0;bottom:0;background:rgba(13,13,15,.9);backdrop-filter:blur(6px);border-top:1px solid #222;padding:8px 12px}
  .footer .row{justify-content:space-between}
  .hint{font-size:12px;color:var(--muted)}
  .video-wrap{position:relative;border-radius:12px;overflow:hidden;border:1px solid #2a2a30}
  video{width:100%;background:#000} #barcode-area{background:#000;}
  canvas{max-width:100%}
  .chip{display:inline-block;background:#1b1b20;border:1px solid #2a2a30;border-radius:999px;padding:6px 10px;font-size:12px;margin-right:6px}
</style>
<!-- External libs -->
<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
</head>
<body>
<header>
  <h1>Eato-style дневной бюджет v2</h1>
  <div class="tabs">
    <div class="tab active" data-tab="today">Сегодня</div>
    <div class="tab" data-tab="add">Добавить еду</div>
    <div class="tab" data-tab="scan">Этикетка / OCR</div>
    <div class="tab" data-tab="barcode">Штрих‑код</div>
    <div class="tab" data-tab="exercise">Тренировка</div>
    <div class="tab" data-tab="weight">Вес & Перекалибровка</div>
    <div class="tab" data-tab="profile">Профиль & Настройки</div>
    <div class="tab" data-tab="data">Данные</div>
  </div>
</header>

<div class="container">
  <!-- TODAY -->
  <section class="card" id="tab-today">
    <div class="kpi">
      <div>
        <div class="pill" id="phase-pill">Фаза: —</div>
        <div class="hint" id="budget-explain">—</div>
      </div>
      <div class="big" id="budget-today">— ккал</div>
    </div>
    <progress id="kcal-progress" max="2000" value="0"></progress>
    <div class="row" style="margin-top:6px">
      <div><b id="kcal-used">0</b>/<span id="kcal-goal">0</span> ккал</div>
      <div class="muted" id="kcal-left">Осталось: —</div>
    </div>
    <div class="grid" style="margin-top:10px">
      <div class="card">
        <div class="kpi"><div>Белок</div><div><b id="p-used">0</b>/<span id="p-goal">0</span> г</div></div>
        <progress id="p-progress" max="100" value="0"></progress>
      </div>
      <div class="card">
        <div class="kpi"><div>Жиры</div><div><b id="f-used">0</b>/<span id="f-goal">0</span> г</div></div>
        <progress id="f-progress" max="100" value="0"></progress>
      </div>
      <div class="card">
        <div class="kpi"><div>Углеводы</div><div><b id="c-used">0</b>/<span id="c-goal">0</span> г</div></div>
        <progress id="c-progress" max="100" value="0"></progress>
      </div>
      <div class="card">
        <div class="kpi"><div>Карб-буфер (ПМС)</div><div><b id="buf-used">0</b>/<span id="buf-goal">0</span> г</div></div>
        <progress id="buf-progress" max="40" value="0"></progress>
        <small class="muted">Опционально: 20–40 г вечером в ПМС.</small>
      </div>
    </div>

    <div class="card">
      <div class="kpi"><div>Сегодняшние записи</div>
        <div class="row">
          <button class="secondary" id="clear-day">Очистить</button>
          <button class="secondary" id="quick-add-200">+200 ккал (быстрый снэк)</button>
        </div>
      </div>
      <div id="entries">—</div>
    </div>
  </section>

  <!-- ADD -->
  <section class="card" id="tab-add" style="display:none">
    <div class="grid">
      <div>
        <label>Название продукта</label>
        <input id="add-name" placeholder="Напр.: Творог 5%">
      </div>
      <div>
        <label>Граммы</label>
        <input id="add-grams" type="number" placeholder="г">
      </div>
    </div>
    <div class="grid" style="margin-top:8px">
      <div><label>ккал /100 г</label><input id="add-kcal" type="number"></div>
      <div><label>Белки г/100г</label><input id="add-p" type="number" step="0.1"></div>
      <div><label>Жиры г/100г</label><input id="add-f" type="number" step="0.1"></div>
      <div><label>Углеводы г/100г</label><input id="add-c" type="number" step="0.1"></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btn-add">Добавить</button>
      <button class="secondary" id="btn-fav">Сохранить как избранный</button>
    </div>
    <div class="card">
      <div class="kpi"><div>Избранные продукты (на 100 г)</div>
        <div><button class="secondary" id="seed-favs">Загрузить базовые</button></div>
      </div>
      <div id="fav-list" class="hint">пока пусто</div>
    </div>
  </section>

  <!-- SCAN / OCR -->
  <section class="card" id="tab-scan" style="display:none">
    <p class="muted">Сфотографируй таблицу «Пищевая ценность» или выбери фото из галереи.</p>
    <div class="row">
      <input type="file" id="photo-input" accept="image/*;capture=camera">
      <button id="btn-ocr-photo" class="secondary">Распознать с фото</button>
    </div>
    <div class="row" style="margin-top:6px">
      <label>Или вставь текст</label>
      <textarea id="ocr-text" placeholder="Например: Энергетическая ценность 121 ккал... Белки 17 г, Жиры 5 г, Углеводы 3 г. На 100 г."></textarea>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btn-parse">Распознать текст</button>
      <button class="secondary" id="btn-use">Заполнить форму добавления</button>
    </div>
    <div class="card">
      <div class="kpi"><div>Результат парсинга</div></div>
      <pre id="ocr-result" style="white-space:pre-wrap"></pre>
    </div>
  </section>

  <!-- BARCODE -->
  <section class="card" id="tab-barcode" style="display:none">
    <p class="muted">Сканируй штрих‑код (EAN‑13). Дадим номер и сохраним в карточку продукта.</p>
    <div class="video-wrap" id="barcode-area" style="min-height:220px; display:block; position:relative;"></div>
    <div class="row" style="margin-top:8px">
      <button id="start-barcode">Старт камеры</button>
      <button class="secondary" id="stop-barcode">Стоп</button>
    </div>
    <div class="card">
      <div class="kpi"><div>Последний скан</div></div>
      <div id="barcode-out" class="hint">—</div>
      <div class="row" style="margin-top:6px">
        <button class="secondary" id="barcode-to-form">Вставить в форму добавления</button>
      </div>
    </div>
  </section>

  <!-- EXERCISE -->
  <section class="card" id="tab-exercise" style="display:none">
    <div class="grid">
      <div><label>Тип тренировки (опционально)</label><input id="ex-type" placeholder="Бег / Силовая / Йога"></div>
      <div><label>Сожжено ккал (по трекеру)</label><input id="ex-burn" type="number" placeholder="напр. 400"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="ex-add">Добавить сегодня</button>
      <button class="secondary" id="ex-clear">Очистить тренировки сегодня</button>
    </div>
    <div class="card">
      <div class="kpi"><div>Сегодняшние тренировки</div></div>
      <div id="ex-list">—</div>
    </div>
  </section>

  <!-- WEIGHT / RECALIBRATION -->
  <section class="card" id="tab-weight" style="display:none">
    <div class="grid">
      <div><label>Вес (кг) на сегодня</label><input id="w-today" type="number" step="0.1"></div>
      <div><label>Дата</label><input id="w-date" type="date"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="w-add">Добавить запись</button>
      <button class="secondary" id="w-recalc">Перекалибровать бюджет (7 дней)</button>
    </div>
    <div class="card">
      <div class="kpi"><div>Лог веса</div></div>
      <div id="w-list" class="hint">—</div>
    </div>
    <small class="muted">Алгоритм сравнивает ожидаемую потерю/набор по дефициту с фактической динамикой веса за ~7 дней и может сдвинуть дневной бюджет на ±100–150 ккал.</small>
  </section>

  <!-- PROFILE -->
  <section class="card" id="tab-profile" style="display:none">
    <div class="grid">
      <div>
        <label>Пол</label>
        <select id="sex"><option value="female">Женский</option><option value="male">Мужской</option></select>
      </div>
      <div><label>Возраст</label><input id="age" type="number" value="30"></div>
      <div><label>Рост (см)</label><input id="height" type="number" value="168"></div>
      <div><label>Вес (кг)</label><input id="weight" type="number" value="65"></div>
    </div>
    <div class="grid" style="margin-top:8px">
      <div>
        <label>Активность</label>
        <select id="activity">
          <option value="1.2">Сидячий (1.2)</option>
          <option value="1.375">Лёгкая (1.375)</option>
          <option value="1.55">Умеренная (1.55)</option>
          <option value="1.725">Высокая (1.725)</option>
          <option value="1.9">Очень высокая (1.9)</option>
        </select>
      </div>
      <div>
        <label>Цель</label>
        <select id="goal">
          <option value="-0.15">Похудение (−15%)</option>
          <option value="-0.10">Похудение (−10%)</option>
          <option value="0">Поддержание</option>
          <option value="0.10">Набор (+10%)</option>
        </select>
      </div>
      <div><label>Белок (г/кг)</label><input id="p-perkg" type="number" step="0.1" value="2.0"></div>
      <div><label>Жир (г/кг)</label><input id="f-perkg" type="number" step="0.1" value="0.8"></div>
    </div>
    <div class="card">
      <div class="kpi"><div>Цикл</div></div>
      <div class="grid">
        <div><label>День начала цикла</label><input id="cycle-start" type="date"></div>
        <div><label>Длина цикла (дн)</label><input id="cycle-len" type="number" value="28"></div>
        <div><label>Лютеиновая фаза (дн)</label><input id="luteal-len" type="number" value="14"></div>
        <div><label>ПМС: карб-буфер, г</label><input id="pms-buffer" type="number" value="30"></div>
      </div>
      <div class="grid" style="margin-top:8px">
        <div><label>Коррекция в овуляцию</label>
          <select id="ovul-adj">
            <option value="mult:1">Нет</option>
            <option value="mult:1.03">×1.03</option>
            <option value="mult:1.05">×1.05</option>
          </select>
        </div>
        <div><label>Коррекция в лютеиновую</label>
          <select id="lut-adj">
            <option value="mult:1.03">×1.03</option>
            <option value="add:150">+150 ккал</option>
            <option value="mult:1">Нет</option>
          </select>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="kpi"><div>Бюджет</div></div>
      <div class="grid">
        <div><label>Перенос между днями (±% от базы)</label><input id="carry-pct" type="number" value="10"></div>
        <div><label>Заработанные калории (коэф.)</label><input id="ex-coeff" type="number" value="0.5" step="0.1"></div>
        <div><label>Лимит earn ккал/день</label><input id="ex-cap" type="number" value="300"></div>
        <div><label>Минимум ккал/день</label><input id="safety-min" type="number" value="1350"></div>
      </div>
    </div>
    <div class="row">
      <button id="save-profile">Сохранить</button>
      <button class="secondary" id="recalc-today">Пересчитать сегодня</button>
    </div>
  </section>

  <!-- DATA -->
  <section class="card" id="tab-data" style="display:none">
    <div class="row">
      <button class="secondary" id="export-json">Экспорт JSON</button>
      <input type="file" id="import-file" accept="application/json">
      <button class="warn" id="wipe-all">Удалить все данные</button>
    </div>
    <small class="muted">Данные хранятся локально в браузере. OCR и штрих‑коды работают офлайн/онлайн (CDN для библиотек нужен при первом открытии).</small>
  </section>
</div>

<div class="footer">
  <div class="row">
    <div class="col"><div class="hint" id="footer-hint">Готово.</div></div>
    <div><button class="secondary" id="add-to-home">Установить (PWA)</button></div>
  </div>
</div>

<script>
// ---------- Utilities / Storage ----------
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const todayKey = () => new Date().toISOString().slice(0,10);
const DB = {
  read(){ try{return JSON.parse(localStorage.getItem('eato_db_v2')||'{}')}catch(e){return {}} },
  write(v){ localStorage.setItem('eato_db_v2', JSON.stringify(v)); },
  patch(fn){ const d = DB.read(); fn(d); DB.write(d); }
};

// ---------- Defaults ----------
const defaults = {
  profile: { sex:'female', age:30, height_cm:168, weight_kg:65, activity:1.375, goal_pct:-0.15, p_perkg:2.0, f_perkg:0.8 },
  cycle: { start: null, len:28, luteal:14, ovulAdj:{type:'mult',v:1.03}, lutealAdj:{type:'mult',v:1.03}, pmsBufferG:30 },
  budget: { carryPct:10, exCoeff:0.5, exCap:300, safetyMin:1350, lastCarry:0 },
  favs: [],
  diary: {},           // date -> entries [{name, grams, per100:{kcal,p,f,c}, barcode?}]
  exercise: {},        // date -> [{type, burn}]
  weight_log: []       // [{date, kg}]
};

function initDB(){
  DB.patch(d=>{
    for(const k of Object.keys(defaults)){
      if(!(k in d)) d[k]=JSON.parse(JSON.stringify(defaults[k]));
    }
  });
}

// ---------- Math ----------
function bmr({sex,weight_kg,height_cm,age}){
  return 10*weight_kg + 6.25*height_cm - 5*age + (sex==='male' ? 5 : -161);
}
function getCycleDay(dateStr, startStr, len=28){
  if(!startStr) return null;
  const d = new Date(dateStr+"T00:00:00");
  const s = new Date(startStr+"T00:00:00");
  const diff = Math.floor((d - s)/(1000*3600*24));
  const day = ((diff % len)+len)%len + 1; return day;
}
function getPhase(day, len=28, lutealLen=14){
  if(day==null) return 'unknown';
  const ovulCenter = len - lutealLen;
  if (day <= 5) return 'menstrual';
  if (day < ovulCenter) return 'follicular';
  if (Math.abs(day - ovulCenter) <= 1) return 'ovulation';
  return 'luteal';
}
function parseAdj(val){
  const [t, num] = val.split(':'); return {type:t, v:Number(num)};
}
function clamp(x,min,max){ return Math.max(min, Math.min(max, x)); }

// Exercise earned kcal today
function todayEarnedKcal(db, dateStr){
  const arr = db.exercise[dateStr]||[]; const totalBurn = arr.reduce((s,e)=>s+Number(e.burn||0),0);
  const coeff = Number(db.budget.exCoeff||0); const cap = Number(db.budget.exCap||0);
  return Math.min(Math.round(totalBurn * coeff), cap);
}

function computeBudget(db, dateStr){
  const pr = db.profile, cyc = db.cycle, bud = db.budget;
  const baseBMR = bmr(pr);
  const tdee = baseBMR * Number(pr.activity);
  let base = Math.round(tdee * (1 + Number(pr.goal_pct)));
  // Phase
  const day = getCycleDay(dateStr, cyc.start, cyc.len);
  const phase = getPhase(day, cyc.len, cyc.luteal);
  const adj = (phase==='ovulation') ? cyc.ovulAdj
             : (phase==='luteal') ? cyc.lutealAdj
             : {type:'mult', v:1};
  if(adj.type==='mult') base = Math.round(base * adj.v);
  if(adj.type==='add')  base = Math.round(base + adj.v);
  // Earned
  const earned = todayEarnedKcal(db, dateStr);
  // Carry
  const carryLimit = Math.round(base * (Number(bud.carryPct)/100));
  let budget = base + earned + clamp(bud.lastCarry||0, -carryLimit, carryLimit);
  // Safety
  budget = Math.max(budget, Number(bud.safetyMin));
  // Macros
  const p_g = Math.round(Number(pr.p_perkg) * Number(pr.weight_kg));
  const f_g = Math.round(Number(pr.f_perkg) * Number(pr.weight_kg));
  const kcalFromPF = p_g*4 + f_g*9;
  const c_g = Math.max(Math.round((budget - kcalFromPF)/4), 0);
  const buf_g = (phase==='luteal') ? Number(cyc.pmsBufferG||0) : 0;
  return {budget, tdee:Math.round(tdee), phase, day, p_g, f_g, c_g, buf_g, earned};
}

// ---------- Diary / Totals ----------
function dayEntries(db, dateStr){ return (db.diary[dateStr]||[]).slice(); }
function addEntry(dateStr, entry){ DB.patch(d=>{ if(!d.diary[dateStr]) d.diary[dateStr]=[]; d.diary[dateStr].push(entry); }); }
function clearDay(dateStr){ DB.patch(d=>{ d.diary[dateStr]=[]; d.budget.lastCarry = 0; d.exercise[dateStr]=[]; }); }
function calcTotals(entries){
  let kcal=0,p=0,f=0,c=0;
  for(const e of entries){
    const mult = Number(e.grams)/100;
    kcal += mult*Number(e.per100.kcal||0);
    p    += mult*Number(e.per100.p||0);
    f    += mult*Number(e.per100.f||0);
    c    += mult*Number(e.per100.c||0);
  }
  return {kcal:Math.round(kcal), p:Math.round(p), f:Math.round(f), c:Math.round(c)};
}

// ---------- OCR ----------
async function ocrImageFile(file){
  const worker = await Tesseract.createWorker('rus+eng+deu', 1, {logger: m=>console.log(m)});
  const { data:{ text, confidence } } = await worker.recognize(file);
  await worker.terminate();
  return { text, confidence };
}
function parseLabelText(rawText){
  if(!rawText) return {base:'unknown', nutrients:{}};
  const t = rawText.toLowerCase().replace(',', '.').replace('кдж', 'kj');
  const grab = (patterns) => {
    const rx = new RegExp(`(?:${patterns.join('|')})\\s*[:=]?\\s*(\\d+(?:\\.\\d+)?)`, 'i');
    const m = t.match(rx); return m ? parseFloat(m[1]) : null;
  };
  let kcal = grab(['kcal','ккал','кал','energy\\s*\\(kcal\\)','brennwert\\s*\\(kcal\\)']);
  const kJ   = grab(['kj','кджоул[ья]','energy\\s*\\(kj\\)','brennwert\\s*\\(kj\\)']);
  if (!kcal && kJ) kcal = Math.round(kJ / 4.184);
  const protein = grab(['protein','eiwei[ß]','eiweiß','белк[аи]']);
  const fat     = grab(['fat','fett','жир[ы]?']);
  const carbs   = grab(['carb[s]?','kohlenhydrate','углевод[ы]?']);
  const sugars  = grab(['sugar[s]?','zucker','сахар[ы]?']);
  const per100 = /(?:per|pro)?\s*100\s*(?:g|gramm|г|ml|мл)/.test(t) || /на\s*100\s*(?:г|мл)/.test(t);
  const perPortion = /(per\s*portion|на\s*порци[юя]|je\s*portion)/.test(t);
  return {
    base: per100 ? 'per100' : (perPortion ? 'per_portion' : 'unknown'),
    nutrients: { kcal, p: protein, f: fat, c: carbs, sugars }
  };
}

// ---------- Barcode (Quagga) ----------
window.__quaggaRunning = Boolean(window.__quaggaRunning);
window.__quaggaHandlers = window.__quaggaHandlers || { detected: null, processed: null };

function startBarcode(){
  if(!window.Quagga){ toast('QuaggaJS не загрузился', true); return; }
  if(window.__quaggaRunning){ toast('Сканирование уже запущено'); return; }
  const container = document.getElementById('barcode-area');
  if(!container){ toast('Не найден контейнер камеры', true); return; }

  // Make sure the tab is visible
  const tab = document.getElementById('tab-barcode');
  if(tab && tab.style.display === 'none'){ tab.style.display = 'block'; }

  // Clean container
  container.innerHTML = '';

  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

  const resetHandlers = () => {
    if(window.__quaggaHandlers.processed){
      Quagga.offProcessed && Quagga.offProcessed(window.__quaggaHandlers.processed);
      window.__quaggaHandlers.processed = null;
    }
    if(window.__quaggaHandlers.detected){
      Quagga.offDetected && Quagga.offDetected(window.__quaggaHandlers.detected);
      window.__quaggaHandlers.detected = null;
    }
  };

  resetHandlers();

  Quagga.init({
    inputStream: {
      type: "LiveStream",
      target: container,                // Quagga will inject its own <video> here
      constraints: {
        facingMode: "environment",
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    },
    locator: { patchSize: "medium", halfSample: true },
    numOfWorkers: isIOS ? 0 : 2,        // iOS Safari needs 0
    frequency: 10,
    locate: true,
    decoder: { readers: ["ean_reader","ean_8_reader","upc_reader","upc_e_reader"] }
  }, function(err){
    if (err) {
      console.log(err);
      toast('Камера недоступна: ' + err.message, true);
      resetHandlers();
      return;
    }

    const onDetected = data => {
      const code = data?.codeResult?.code;
      if(code){
        container.style.boxShadow = "inset 0 0 0 3px rgba(74,222,128,.6)";
        $('#barcode-out').textContent = code;
        // Stop after first good scan to avoid duplicates
        stopBarcode();
      }
    };

    const onProcessed = result => {
      // Add simple overlay by toggling background if no result
      if(!result || !result.boxes || result.boxes.length===0){
        container.style.boxShadow = "inset 0 0 0 2px rgba(255,255,255,.1)";
      }else{
        container.style.boxShadow = "inset 0 0 0 2px rgba(45,212,191,.4)";
      }
    };

    Quagga.onDetected(onDetected);
    Quagga.onProcessed(onProcessed);

    window.__quaggaHandlers.detected = onDetected;
    window.__quaggaHandlers.processed = onProcessed;

    Quagga.start();
    window.__quaggaRunning = true;
    toast('Сканирование запущено');
  });
}
function stopBarcode(){
  try{
    if(window.Quagga && window.__quaggaRunning){
      if(window.__quaggaHandlers){
        if(window.__quaggaHandlers.processed && Quagga.offProcessed){
          Quagga.offProcessed(window.__quaggaHandlers.processed);
        }
        if(window.__quaggaHandlers.detected && Quagga.offDetected){
          Quagga.offDetected(window.__quaggaHandlers.detected);
        }
        window.__quaggaHandlers.processed = null;
        window.__quaggaHandlers.detected = null;
      }
      Quagga.stop();
      window.__quaggaRunning = false;
    }
    const container = document.getElementById('barcode-area');
    if(container) container.style.boxShadow = "none";
    toast('Сканирование остановлено');
  }catch(e){
    console.log(e);
  }
}

// ---------- Weight & Recalibration ----------
function renderWeight(){
  const db = DB.read();
  $('#w-list').innerHTML = db.weight_log.length ? db.weight_log.map(w=>`<div class="row" style="justify-content:space-between;border-bottom:1px dashed #2a2a30;padding:6px 0">
    <div>${w.date}</div><div>${w.kg} кг</div>
  </div>`).join('') : '—';
}
function addWeight(date, kg){
  DB.patch(d=>{ 
    d.weight_log = d.weight_log.filter(w=>w.date!==date).concat([{date, kg:Number(kg)}]).sort((a,b)=>a.date.localeCompare(b.date));
    if(date===todayKey()) d.profile.weight_kg = Number(kg);
  });
}
function sevenDayRecalibrate(){
  const db = DB.read();
  if(db.weight_log.length<2){ toast('Недостаточно записей веса', true); return; }
  // take last ~7-10 days window
  const wl = db.weight_log.slice(-2);
  const [wPrev, wNow] = wl;
  const days = Math.max( (new Date(wNow.date)-new Date(wPrev.date))/(1000*3600*24), 1);
  const deltaKg = Number(wNow.kg) - Number(wPrev.kg);
  // compute actual avg daily intake vs budget to estimate achieved deficit
  // Use diary totals vs computeBudget baseline for each day (if present)
  let totalBudget=0, totalIntake=0, count=0;
  for(let i=0;i<=Math.ceil(days);i++){
    const d = new Date(new Date(wPrev.date).getTime()+i*86400000); const key = d.toISOString().slice(0,10);
    const comp = computeBudget(db, key); totalBudget += comp.budget;
    const entries = dayEntries(db, key); const tot = calcTotals(entries); totalIntake += tot.kcal; count++;
  }
  const avgDef = (totalBudget - totalIntake)/count; // kcal/day
  const expectedDeltaKg = -(avgDef*days)/7700; // negative means weight loss
  // Compare trend
  const diffKg = (deltaKg - expectedDeltaKg);
  let adjust = 0;
  if(Math.abs(diffKg) > 0.2){ // if off by >200g over window
    adjust = diffKg>0 ? -120 : +120; // if losing меньше ожидаемого -> снизить бюджет; если быстрее -> повысить
    DB.patch(d=>{ d.budget.lastCarry += Math.round(adjust); });
    toast(`Перекалибровано: ${adjust>0?'+':''}${adjust} ккал/день через перенос`);
  }else{
    toast('Перекалибровка не требуется');
  }
  renderToday();
}

// ---------- UI ----------
function renderToday(){
  const db = DB.read(); const date = todayKey();
  const comp = computeBudget(db, date);
  const entries = dayEntries(db, date);
  const totals = calcTotals(entries);
  const carry = clamp(Math.round((comp.budget - totals.kcal)), -Math.round(comp.budget*db.budget.carryPct/100), Math.round(comp.budget*db.budget.carryPct/100));
  DB.patch(d=>{ d.budget.lastCarry = carry; }); // store carry for tomorrow
  // Header
  $('#budget-today').textContent = comp.budget + ' ккал';
  $('#kcal-progress').max = comp.budget; $('#kcal-progress').value = totals.kcal;
  $('#kcal-used').textContent = totals.kcal; $('#kcal-goal').textContent = comp.budget;
  $('#kcal-left').textContent = 'Осталось: ' + Math.max(comp.budget - totals.kcal, 0) + ' ккал';
  // Macros
  $('#p-progress').max = comp.p_g; $('#p-progress').value = totals.p;
  $('#f-progress').max = comp.f_g; $('#f-progress').value = totals.f;
  $('#c-progress').max = comp.c_g; $('#c-progress').value = totals.c;
  $('#buf-progress').max = comp.buf_g || 40; $('#buf-progress').value = Math.max(totals.c - comp.c_g, 0);
  $('#p-used').textContent = totals.p; $('#p-goal').textContent = comp.p_g;
  $('#f-used').textContent = totals.f; $('#f-goal').textContent = comp.f_g;
  $('#c-used').textContent = totals.c; $('#c-goal').textContent = comp.c_g;
  $('#buf-used').textContent = Math.max(totals.c - comp.c_g, 0); $('#buf-goal').textContent = comp.buf_g || 0;
  // Phase pill
  const dayStr = (comp.day!=null)?`день ${comp.day}/${DB.read().cycle.len}`:'—';
  $('#phase-pill').textContent = 'Фаза: ' + comp.phase + ' ('+ dayStr + ')';
  $('#budget-explain').textContent = `TDEE ${comp.tdee} • цель ${Math.round((1+Number(DB.read().profile.goal_pct))*100)}% • перенос ${DB.read().budget.lastCarry} • earn ${comp.earned}`;
  // Entries list
  const list = entries.map(e=>{
    const mult = Number(e.grams)/100;
    const kcal = Math.round(mult*e.per100.kcal);
    const p = Math.round(mult*e.per100.p);
    const f = Math.round(mult*e.per100.f);
    const c = Math.round(mult*e.per100.c);
    const bc = e.barcode? `<span class="chip">EAN ${e.barcode}</span>` : '';
    return `<div class="row" style="justify-content:space-between;border-bottom:1px dashed #2a2a30;padding:6px 0">
      <div>${e.name} • ${e.grams} г ${bc}</div>
      <div class="muted">${kcal} ккал • Б${p}/Ж${f}/У${c}</div>
    </div>`;
  }).join('');
  $('#entries').innerHTML = list || '—';
  renderExercise();
}
function renderFavs(){
  const favs = DB.read().favs||[];
  $('#fav-list').innerHTML = favs.length? favs.map((f,i)=>`<div class="row" style="justify-content:space-between;padding:6px 0;border-bottom:1px dashed #2a2a30">
    <div>${f.name} — ${f.per100.kcal} ккал, Б${f.per100.p}/Ж${f.per100.f}/У${f.per100.c}</div>
    <div><button class="secondary" onclick="useFav(${i})">Добавить</button></div>
  </div>`).join('') : 'пока пусто';
}
function useFav(i){
  const f = DB.read().favs[i]; if(!f) return;
  $('#add-name').value = f.name; $('#add-kcal').value = f.per100.kcal; $('#add-p').value = f.per100.p; $('#add-f').value = f.per100.f; $('#add-c').value = f.per100.c; $('#add-grams').focus();
}
function seedFavs(){
  const base = [
    {name:'Творог 5%', per100:{kcal:121,p:17,f:5,c:3}},
    {name:'Куриная грудка', per100:{kcal:110,p:23,f:2,c:0}},
    {name:'Овсянка сухая', per100:{kcal:370,p:12,f:7,c:62}},
    {name:'Яблоко', per100:{kcal:52,p:0.3,f:0.2,c:14}},
    {name:'Оливковое масло', per100:{kcal:900,p:0,f:100,c:0}},
  ];
  DB.patch(d=>{ d.favs = base; });
  renderFavs(); toast('Загружены базовые продукты');
}

// ---------- Events ----------
function bind(){
  // Tabs
  $$('.tab').forEach(el=>el.addEventListener('click', e=>{
    $$('.tab').forEach(t=>t.classList.remove('active'));
    el.classList.add('active');
    const key = el.dataset.tab;
    ['today','add','scan','barcode','exercise','weight','profile','data'].forEach(k=>$('#tab-'+k).style.display = (k===key?'block':'none'));
    if(key==='barcode'){ /* ready */ } else { stopBarcode(); }
  }));

  // Quick snack
  $('#quick-add-200').addEventListener('click', ()=>{
    addEntry(todayKey(), {name:'Снэк', grams:100, per100:{kcal:200,p:5,f:10,c:20}});
    renderToday();
  });

  // Add entry
  $('#btn-add').addEventListener('click', ()=>{
    const name = $('#add-name').value||'Продукт';
    const grams = Number($('#add-grams').value||0);
    const per100 = { kcal:Number($('#add-kcal').value||0), p:Number($('#add-p').value||0), f:Number($('#add-f').value||0), c:Number($('#add-c').value||0) };
    if(grams<=0 || !per100.kcal){ toast('Заполни граммы и ккал/100г', true); return; }
    // If barcode scanned recently, attach it
    const latestCode = $('#barcode-out').textContent && $('#barcode-out').textContent!=='—' ? $('#barcode-out').textContent : null;
    addEntry(todayKey(), {name, grams, per100, barcode: latestCode});
    renderToday(); toast('Добавлено');
  });
  $('#btn-fav').addEventListener('click', ()=>{
    const name = $('#add-name').value||'';
    if(!name){ toast('Нужно название', true); return; }
    const per100 = { kcal:Number($('#add-kcal').value||0), p:Number($('#add-p').value||0), f:Number($('#add-f').value||0), c:Number($('#add-c').value||0) };
    DB.patch(d=>{ d.favs.push({name, per100}); });
    renderFavs(); toast('Сохранено в избранные');
  });
  $('#seed-favs').addEventListener('click', seedFavs);

  // OCR from photo
  $('#btn-ocr-photo').addEventListener('click', async ()=>{
    const f = $('#photo-input').files?.[0];
    if(!f){ toast('Выбери фото', true); return; }
    toast('Распознаю...');
    try{
      const {text, confidence} = await ocrImageFile(f);
      $('#ocr-text').value = text;
      $('#ocr-result').textContent = `OCR confidence: ${Math.round(confidence)}%\n\n` + text.slice(0,4000);
      toast('OCR готов');
    }catch(err){ console.error(err); toast('Ошибка OCR', true); }
  });

  // OCR parse from text
  let lastParsed = null;
  $('#btn-parse').addEventListener('click', ()=>{
    const text = $('#ocr-text').value;
    const parsed = parseLabelText(text); lastParsed = parsed;
    const n = parsed.nutrients;
    const kcalFrom = (n.p||0)*4 + (n.f||0)*9 + (n.c||0)*4;
    const ok = n.kcal ? Math.abs(kcalFrom - n.kcal) < 0.15*(n.kcal) : true;
    $('#ocr-result').textContent = JSON.stringify({base:parsed.base, nutrients:n, kcal_check:`${kcalFrom} vs ${n.kcal}`, ok}, null, 2);
  });
  $('#btn-use').addEventListener('click', ()=>{
    if(!lastParsed){ toast('Сначала «Распознать»', true); return; }
    const n = lastParsed.nutrients;
    if(lastParsed.base==='per_portion'){
      const portion = prompt('Обнаружена «на порцию». Введите вес порции (г):','100');
      const pg = Number(portion||100);
      for(const k of ['kcal','p','f','c']){
        if(n[k]!=null) n[k] = Math.round( (n[k]/pg) * 100 * 10 )/10;
      }
    }
    if(n.kcal!=null) $('#add-kcal').value = n.kcal;
    if(n.p!=null) $('#add-p').value = n.p;
    if(n.f!=null) $('#add-f').value = n.f;
    if(n.c!=null) $('#add-c').value = n.c;
    toast('Форма заполнена из этикетки');
  });

  // Barcode
  $('#start-barcode').addEventListener('click', startBarcode);
  $('#stop-barcode').addEventListener('click', stopBarcode);
  $('#barcode-to-form').addEventListener('click', ()=>{
    const code = $('#barcode-out').textContent;
    if(!code || code==='—'){ toast('Сначала отсканируй', true); return; }
    // append barcode to name
    let name = $('#add-name').value||'Продукт';
    if(!/EAN/.test(name)) name += ` (EAN ${code})`;
    $('#add-name').value = name;
    toast('Штрих‑код добавлен к продукту');
  });

  // Exercise
  $('#ex-add').addEventListener('click', ()=>{
    const burn = Number($('#ex-burn').value||0); const type = $('#ex-type').value||'';
    if(burn<=0){ toast('Укажи ккал', true); return; }
    DB.patch(d=>{ if(!d.exercise[todayKey()]) d.exercise[todayKey()] = []; d.exercise[todayKey()].push({type, burn}); });
    $('#ex-burn').value=''; $('#ex-type').value=''; renderExercise(); renderToday(); toast('Тренировка добавлена');
  });
  $('#ex-clear').addEventListener('click', ()=>{ DB.patch(d=>{ d.exercise[todayKey()] = []; }); renderExercise(); renderToday(); });

  // Weights
  const today = todayKey(); $('#w-date').value = today;
  $('#w-add').addEventListener('click', ()=>{
    const date = $('#w-date').value || todayKey(); const kg = Number($('#w-today').value||0);
    if(!kg){ toast('Укажи вес', true); return; }
    addWeight(date, kg); renderWeight(); hydrateProfile(); renderToday(); toast('Вес сохранён');
  });
  $('#w-recalc').addEventListener('click', sevenDayRecalibrate);

  // Profile save
  $('#save-profile').addEventListener('click', ()=>{
    DB.patch(d=>{
      d.profile.sex = $('#sex').value;
      d.profile.age = Number($('#age').value||30);
      d.profile.height_cm = Number($('#height').value||168);
      d.profile.weight_kg = Number($('#weight').value||65);
      d.profile.activity = Number($('#activity').value||1.375);
      d.profile.goal_pct = Number($('#goal').value||0);
      d.profile.p_perkg = Number($('#p-perkg').value||2.0);
      d.profile.f_perkg = Number($('#f-perkg').value||0.8);
      d.cycle.start = $('#cycle-start').value||null;
      d.cycle.len = Number($('#cycle-len').value||28);
      d.cycle.luteal = Number($('#luteal-len').value||14);
      d.cycle.pmsBufferG = Number($('#pms-buffer').value||30);
      d.cycle.ovulAdj = parseAdj($('#ovul-adj').value);
      d.cycle.lutealAdj = parseAdj($('#lut-adj').value);
      d.budget.carryPct = Number($('#carry-pct').value||10);
      d.budget.exCoeff = Number($('#ex-coeff').value||0.5);
      d.budget.exCap = Number($('#ex-cap').value||300);
      d.budget.safetyMin = Number($('#safety-min').value||1350);
    });
    renderToday(); toast('Профиль сохранён');
  });
  $('#recalc-today').addEventListener('click', ()=>{ renderToday(); toast('Пересчитано'); });

  $('#clear-day').addEventListener('click', ()=>{ if(confirm('Очистить записи за сегодня и тренировки?')){ clearDay(todayKey()); renderToday(); }});

  // Export / Import / Wipe
  $('#export-json').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(DB.read(), null, 2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'eato_prototype_v2_export.json'; a.click();
  });
  $('#import-file').addEventListener('change', (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const fr = new FileReader(); fr.onload = ()=>{ try{
      const obj = JSON.parse(fr.result); localStorage.setItem('eato_db_v2', JSON.stringify(obj));
      initDB(); renderFavs(); renderToday(); renderWeight(); renderExercise(); hydrateProfile(); toast('Импортировано');
    }catch(err){ toast('Ошибка JSON', true);} }; fr.readAsText(file);
  });
  $('#wipe-all').addEventListener('click', ()=>{
    if(confirm('Удалить все локальные данные?')){ localStorage.removeItem('eato_db_v2'); initDB(); renderFavs(); renderToday(); renderWeight(); renderExercise(); hydrateProfile(); toast('Готово'); }
  });

  // PWA install
  setupPWA();
}

function renderExercise(){
  const db = DB.read(); const arr = db.exercise[todayKey()]||[];
  $('#ex-list').innerHTML = arr.length? arr.map(e=>`<div class="row" style="justify-content:space-between;border-bottom:1px dashed #2a2a30;padding:6px 0">
    <div>${e.type||'Тренировка'}</div><div>${e.burn} ккал</div>
  </div>`).join('') : '—';
}

function hydrateProfile(){
  const d = DB.read();
  $('#sex').value = d.profile.sex;
  $('#age').value = d.profile.age;
  $('#height').value = d.profile.height_cm;
  $('#weight').value = d.profile.weight_kg;
  $('#activity').value = String(d.profile.activity);
  $('#goal').value = String(d.profile.goal_pct);
  $('#p-perkg').value = d.profile.p_perkg;
  $('#f-perkg').value = d.profile.f_perkg;
  if(d.cycle.start) $('#cycle-start').value = d.cycle.start;
  $('#cycle-len').value = d.cycle.len;
  $('#luteal-len').value = d.cycle.luteal;
  $('#pms-buffer').value = d.cycle.pmsBufferG;
  $('#ovul-adj').value = `${d.cycle.ovulAdj.type}:${d.cycle.ovulAdj.v}`;
  $('#lut-adj').value = `${d.cycle.lutealAdj.type}:${d.cycle.lutealAdj.v}`;
  $('#carry-pct').value = d.budget.carryPct;
  $('#ex-coeff').value = d.budget.exCoeff;
  $('#ex-cap').value = d.budget.exCap;
  $('#safety-min').value = d.budget.safetyMin;
}

function toast(msg, isErr=false){
  const el = $('#footer-hint'); el.textContent = msg; el.style.color = isErr? 'var(--danger)':'var(--muted)';
  setTimeout(()=>{ el.style.color = 'var(--muted)'; }, 1800);
}

// ---------- Manifest + SW ----------
function setupPWA(){
  const manifest = {
    name: "Eato-style дневной бюджет v2",
    short_name: "Eato Budget",
    start_url: ".",
    display: "standalone",
    background_color: "#0d0d0f",
    theme_color: "#111111",
    icons: []
  };
  const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  document.getElementById('app-manifest').setAttribute('href', url);

  if('serviceWorker' in navigator){
    const swCode = `self.addEventListener('install',e=>{self.skipWaiting();});
self.addEventListener('activate',e=>{clients.claim();});
self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match('offline')))});`;
    const swBlob = new Blob([swCode], {type:'text/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).catch(()=>{});
  }
}

// ---------- Boot ----------
initDB();
bind();
hydrateProfile();
renderFavs();
renderToday();
renderWeight();
renderExercise();
</script>
</body>
</html>
